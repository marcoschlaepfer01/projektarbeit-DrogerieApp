@page "/lindaaff-form"
@rendermode InteractiveServer
@using System.Net.Http.Json
@using DrogerieApp.ClassLibrary.ContentModels.Lindaaff
@using DrogerieApp.RazorClassLibrary.Components
@inject BackendClient BackendClient

<div class="container mt-4">
    <h3 class="text-primary text-center mb-4">Lindaaff Form</h3>
    <EditForm Model="content" OnValidSubmit="SubmitForm" class="shadow p-4 rounded bg-light">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" />

        <div class="row mb-4">
            <div class="col-md-4 text-center">
                <h5 class="mb-3">Select Body Part</h5>
                <div class="d-flex justify-content-center">
                    <div>
                        <HumanBody TriggerCallback="OnBodyClicked" />
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Localization (Additional Info)</label>
                        <InputText @bind-Value="content.AdditionalLocalizationNotes" class="form-control" placeholder="Enter further details about localization" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Intensity</label>
                        <InputText @bind-Value="content.Intensity" class="form-control" placeholder="Rate the intensity (e.g., 1-10)" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Nature</label>
                        <InputText @bind-Value="content.Nature" class="form-control" placeholder="Describe the nature of symptoms" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Duration</label>
                        <InputText @bind-Value="content.Duration" class="form-control" placeholder="How long have you had these symptoms?" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Other Symptoms</label>
                        <InputText @bind-Value="content.OtherSymptoms" class="form-control" placeholder="List any additional symptoms" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Worsening Factors</label>
                        <InputText @bind-Value="content.WorseningFactors" class="form-control" placeholder="What makes it worse?" />
                    </div>
                </div>
                <div class="row mb-3 justify-content-center">
                    <div class="col-md-8">
                        <label class="form-label">Alleviating Factors</label>
                        <InputText @bind-Value="content.AlleviatingFactors" class="form-control" placeholder="What makes it better?" />
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-primary btn-lg px-5">Submit</button>
        </div>
    </EditForm>

    @if (showStatus)
    {
        <div class="mt-4 p-4 bg-light rounded shadow-sm">
            <h5 class="text-secondary">Diagnosis Result</h5>
            @if (isLoading)
            {
                <div class="spinner-border text-primary me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Processing your request...</span>
            }
            else if (responseData != null)
            {
                <!-- Condition Overview -->
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Condition:</div>
                    <div class="col-9">
                        @responseData["conditionName"]
                        @if (responseData.ContainsKey("conditionUmlsCode") && !string.IsNullOrWhiteSpace(responseData["conditionUmlsCode"]))
                        {
                            <span class="text-muted">(UMLS: @responseData["conditionUmlsCode"])</span>
                        }
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-3 fw-bold">Condition Description:</div>
                    <div class="col-9">@responseData["conditionDescription"]</div>
                </div>

                <hr />

                <!-- Medication -->
                <h5>Medication</h5>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Name:</div>
                    <div class="col-9">
                        <a href="@responseData["medicationUrl"]" target="_blank">
                            @responseData["medicationName"]
                        </a>
                        @if (responseData.ContainsKey("medicationUmlsCode") && !string.IsNullOrWhiteSpace(responseData["medicationUmlsCode"]))
                        {
                            <span class="text-muted">(UMLS: @responseData["medicationUmlsCode"])</span>
                        }
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Description:</div>
                    <div class="col-9">@responseData["medicationDescription"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Characteristics:</div>
                    <div class="col-9">@responseData["medicationCharacteristics"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">ATC Code:</div>
                    <div class="col-9">@responseData["medicationAtc"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Dose:</div>
                    <div class="col-9">@responseData["medicationDose"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Indication:</div>
                    <div class="col-9">@responseData["medicationIndication"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Contra-Indication:</div>
                    <div class="col-9">@responseData["medicationContraIndication"]</div>
                </div>
                <div class="row mb-2">
                    <div class="col-3 fw-bold">Narcotic Code:</div>
                    <div class="col-9">@responseData["medicationNarcoticCode"]</div>
                </div>
                <div class="row mb-4">
                    <div class="col-3 fw-bold">Medication Image:</div>
                    <div class="col-9">
                        <img src="@responseData["medicationImageUrl"]" alt="Medication image" style="max-width: 150px;" />
                    </div>
                </div>

                <hr />

                <!-- Explanation -->
                <div class="row">
                    <div class="col-3 fw-bold">Explanation:</div>
                    <div class="col-9">@responseData["explanation"]</div>
                </div>
            }
            else
            {
                <p class="text-danger">No data received.</p>
            }
        </div>
    }
</div>

@code {
    private LindaaffContent content = new LindaaffContent();
    private bool isLoading = false;
    private bool showStatus = false;
    private Dictionary<string, string> responseData;
    private SemaphoreSlim semaphore = new SemaphoreSlim(1);

    private async Task SubmitForm()
    {
        await semaphore.WaitAsync();
        try
        {
            showStatus = true;
            isLoading = true;
            responseData = null;

            // Call the new (more powerful) backend method
            var result = await BackendClient.SubmitFormAsync(content);

            // Map the new result object into a Dictionary
            responseData = new()
            {
                // Condition
                { "conditionName", result.Condition.Name },
                { "conditionUmlsCode", result.Condition.UmlsCode ?? string.Empty },
                { "conditionDescription", result.Condition.Description },

                // Medication
                { "medicationName", result.Medication.MedicationDetails.Name },
                { "medicationUrl", result.Medication.MedicationDetails.Url },
                { "medicationUmlsCode", result.Medication.UmlsCode ?? string.Empty },
                { "medicationDescription", result.Medication.Description },
                { "medicationCharacteristics", result.Medication.MedicationDetails.Characteristics },
                { "medicationAtc", result.Medication.MedicationDetails.Atc },
                { "medicationDose", result.Medication.MedicationDetails.Dose },
                { "medicationIndication", result.Medication.MedicationDetails.Indication },
                { "medicationContraIndication", result.Medication.MedicationDetails.ContraIndication },
                { "medicationNarcoticCode", result.Medication.MedicationDetails.NarcoticCode },
                { "medicationImageUrl", result.Medication.MedicationDetails.ImageUrl },

                // Explanation from the backend
                { "explanation", result.Explanation }
            };
        }
        catch (Exception ex)
        {
            responseData = new()
            {
                // Condition
                { "conditionName", "Error" },
                { "conditionUmlsCode", string.Empty },
                { "conditionDescription", string.Empty },

                // Medication
                { "medicationName", string.Empty },
                { "medicationUrl", string.Empty },
                { "medicationUmlsCode", string.Empty },
                { "medicationDescription", string.Empty },
                { "medicationCharacteristics", string.Empty },
                { "medicationAtc", string.Empty },
                { "medicationDose", string.Empty },
                { "medicationIndication", string.Empty },
                { "medicationContraIndication", string.Empty },
                { "medicationNarcoticCode", string.Empty },
                { "medicationImageUrl", string.Empty },

                // Explanation from the backend
                { "explanation", $"An error occured: {ex.Message}" }
            };
        }
        finally
        {
            isLoading = false;
            semaphore.Release();
        }
    }

    private void OnBodyClicked(IEnumerable<string> selectedParts)
    {
        content.Localization = selectedParts;
    }
}
